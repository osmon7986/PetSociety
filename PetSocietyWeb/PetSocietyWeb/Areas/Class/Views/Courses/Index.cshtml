@model IEnumerable<Course>
@Html.AntiForgeryToken()

@{
    ViewData["Title"] = "課程管理";
}

@section Styles 
{
    <!-- dataTables -->
    <link href="~/lib/datatables/css/jquery.datatables.min.css" rel="stylesheet" />
    <style>
        table.dataTable tbody td,
        table.dataTable tbody th {
            vertical-align: middle !important;
        }

        table.dataTable tbody td {
            color: #4A3A2A !important;
        }

        .btn-edit {
            background: #6c757d;
            color: #fff;
        }
    </style>
}

<h1>課程管理</h1>

<p>
    <a asp-action="Create" class="btn btn-primary rounded-pill">新增課程</a>
</p>
<table id="courseTable" class="table table-striped table-hover table-responsive">
    <thead>
        <tr >
            <th>imageUrl</th>
            <th>title</th>
            <th>categoryName</th>
            <th>instructorName</th>
            <th>price</th>
            <th>status</th>
            <th>createdDate</th>
            <th></th>
        </tr>
    </thead>
</table>

@section Scripts 
{
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="~/lib/datatables/js/jquery.datatables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        let table;
        $(document).ready(function(){
            // alert('ready');
            // 載入DataTable
            table = $('#courseTable').DataTable({
                ajax: {
                    type: "POST",
                    url: "/Class/Courses/IndexJson",
                    dataSrc: function(json){
                        return json;
                    }
                },
				order:[[6, 'desc']], // 依建立日期排序
                columns: [
                    {
                        data: 'imageUrl', 
                        title: "課程圖片",
                        render: function(data) {
                            if (!data) return "";
                            return `<img src="${data}"
                                         alt="課程圖片"
                                         style="width: 80px; height: auto; border-radius: 6px; object-fit: cover;" />
                                            `;
                        }
                    },
                    {data: 'title', title: "課程名稱"},
                    {data: 'categoryName', title: "分類名稱"},
                    {data: 'instructorName', title: "講師名稱"},
                    {
                        data: 'price', 
                        title: "單價",
                        className: 'text-end',
                        render: function(data, type){
                            if (!data) return 0;
                            if (type === 'display'){
                                return "$" + Number(data).toLocaleString('zh-TW');
                            }
                            return data;
                        }
                    },
                    {
                        data: 'status', 
                        title: "發布狀態",
                        className: 'text-center',
                        render: function(data){
                            switch(data){
                                case 1:
                                    return '<span class="badge bg-success">上架中</span>';
                                case 2:
                                    return '<span class="badge bg-secondary">下架中</span>';
                                default:
                                    return '<span class="badge" style="background:#5bc0de;">草稿</span>';
                            }
                        }
                        
                    },
                    {
                        data: 'createdDate', 
                        title: "建立日期",
                        render: function(data){
                            let d = new Date(data);
                            return d.toLocaleDateString('zh-TW');
                        }
                    },
                    {
                        data: null,
                        title: "操作",
                        className: 'text-center',
                        orderable: false,
                        render: function(data, type, row){
                            return `
                            <a href="/Class/Courses/Edit/${row.courseId}" class="btn btn-sm btn-secondary me-1">編輯</a>
                            <button class="btn btn-sm btn-danger btn-delete" data-id="${row.courseId}">刪除</button>`;
                        }
                    },
                    
                ],
                language:{
                    url: '//cdn.datatables.net/plug-ins/2.3.5/i18n/zh-HANT.json',
                },
            })

            $('#courseTable').on('click', '.btn-delete', function(){
                // 用 data-id 取得選取的 course ID
                let courseId = $(this).data('id');
                // 抓token
                let token = $('input[name="__RequestVerificationToken"]').val();
                
                // 呼叫 SweetAlert2
                Swal.fire({
                    title: '確定要刪除這堂課程嗎？',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#7C6958',
                    cancelButtonColor: '#d33',
                    confirmButtonText: '是的，刪除！',
                    cancelButtonText: '取消',
                }).then((result) => {
                    // 使用者確定後執行
                    if(result.isConfirmed){
                        $.ajax({
                            url: `/Class/Courses/Delete/${courseId}`,
                            type: "POST",
                            data: {
                                __RequestVerificationToken: token
                            },
                            success: function(response){
                                // datatable reload
                                table.ajax.reload(null, false);
                                Swal.fire('已刪除', '檔案已刪除', 'success');
                            },
                            error: function(err){
                                Swal.fire('錯誤', '刪除失敗', 'error');
                            }            
                       });
                    } 
                });
            })
        })
    </script>

}