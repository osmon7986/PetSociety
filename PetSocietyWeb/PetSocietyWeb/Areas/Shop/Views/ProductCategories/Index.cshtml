@{
    ViewData["Title"] = "商品類別管理";
}

@section Styles
{
    <link href="~/lib/datatables/css/jquery.datatables.min.css" rel="stylesheet" />

    <style>
        table.dataTable tbody tr td {
            color: #000 !important;
            vertical-align: middle;
        }

        .text-nowrap {
            white-space: nowrap !important;
        }

        div.dataTables_scrollHeadInner,
        table.dataTable {
            width: 100% !important;
        }
    </style>
}

<div class="mb-3">
    <a asp-action="Create" class="btn btn-primary">
        <i class="fa-solid fa-plus"></i> 新增分類
    </a>
</div>

<table id="categoriesTable" class="table table-striped table-hover" style="width:100%">
    <thead class="table-primary">
        <tr>
            <th>分類名稱</th>
            <th>分類描述</th>
            <th>管理功能</th>
        </tr>
    </thead>
</table>

@section Scripts
{
    <script src="~/lib/datatables/js/jquery.datatables.min.js"></script>

    <script>
        $(document).ready(function () {
            var table = $("#categoriesTable").DataTable({
                stateSave: true, // 記住狀態

                ajax: {
                    type: "POST",
                    url: "/Shop/ProductCategories/IndexJson", // ★ 指向剛剛新增的 Controller 方法
                    dataSrc: function (data) {
                        return data;
                    },
                    error: function (xhr, error, thrown) {
                        console.error("資料載入失敗:", error);
                    }
                },
                scrollX: true,
                autoWidth: false,
                columns: [
                    { data: "categoryName", width: "20%" },
                    { data: "description", width: "50%" },
                    {
                        data: "categoryId",
                        width: "30%",
                        orderable: false, // 不排序
                        className: "text-nowrap",
                        render: function (data, type, row) {
                            return `
                                <div class="btn-group" role="group">
                                    <a href="/Shop/ProductCategories/Edit/${data}" class="btn btn-sm btn-warning text-dark">
                                        <i class="fa-solid fa-pen-to-square"></i> 編輯
                                    </a>
                                    <a href="/Shop/ProductCategories/Details/${data}" class="btn btn-sm btn-info text-white">
                                        <i class="fa-solid fa-circle-info"></i> 明細
                                    </a>
                                    <a href="/Shop/ProductCategories/Delete/${data}" class="btn btn-sm btn-danger">
                                        <i class="fa-solid fa-trash-can"></i> 刪除
                                    </a>
                                </div>
                            `;
                        }
                    }
                ],
                language: {
                    url: '//cdn.datatables.net/plug-ins/2.3.5/i18n/zh-HANT.json',
                },
                initComplete: function (settings, json) {
                    setTimeout(function () {
                        table.columns.adjust();
                    }, 200);
                }
            });

            // RWD 縮放優化
            var tableContainer = document.querySelector('#categoriesTable').parentElement;
            if (window.ResizeObserver) {
                const resizeObserver = new ResizeObserver(entries => {
                    window.requestAnimationFrame(() => {
                        table.columns.adjust();
                    });
                });
                resizeObserver.observe(tableContainer);
            } else {
                $(window).on('resize', function () {
                    table.columns.adjust();
                });
            }
        });
    </script>
}