@{
    ViewData["Title"] = "商品管理";
}

@section Styles
{
    <link href="~/lib/datatables/css/jquery.datatables.min.css" rel="stylesheet" />

    <style>
        /* * 1. 表格垂直置中
                 * 讓文字在格子裡上下置中，避免圖片撐高欄位時，文字卻卡在最上面，看起來不協調。
                 */
        table.dataTable tbody tr td {
            color: #000 !important; /* 強制文字黑色，避免被其他 CSS 覆蓋 */
            vertical-align: middle;
        }

        /* * 2. 防止按鈕換行
                 * 避免當螢幕變窄時，"編輯/刪除" 按鈕被擠成上下兩排，強制保持在同一行以節省空間。
                 */
        .text-nowrap {
            white-space: nowrap !important;
        }

        /* * 3. DataTables 對齊修正
                 * 當開啟 scrollX (水平捲軸) 時，表頭(Header)跟內容(Body)有時候會對不齊。
                 * 強制設定 width: 100% 可以解決右邊出現白色空隙的問題。
                 */
        div.dataTables_scrollHeadInner,
        table.dataTable {
            width: 100% !important;
        }

        /* * 4. 圖片縮圖樣式 (新增)
                 * 固定圖片大小，避免上傳長寬比不同的圖片導致表格變形。
                 * object-fit: cover 能確保圖片填滿方框且不變形 (類似 IG 頭像效果)。
                 */
        .product-thumbnail {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
    </style>
}

<div class="mb-3">
    <a href="/Shop/Products/Create" class="btn btn-primary">
        <i class="fa-solid fa-plus"></i> 新增商品
    </a>
    <a asp-action="ExportToExcel" class="btn btn-success">
        <i class="fa-solid fa-file-excel"></i> 匯出 Excel
    </a>
</div>

<table id="productsTable" class="table table-striped table-hover" style="width:100%">
    <thead class="table-primary">
        <tr>
            <td>圖片</td>
            <td>商品名稱</td>
            <td>分類</td>
            <td>賣家</td>
            <td>單價</td>
            <td>庫存</td>
            <td>狀態</td>
            <td>建立時間</td>
            <td>管理功能</td>
        </tr>
    </thead>
</table>

@section Scripts
{
    <script src="~/lib/datatables/js/jquery.datatables.min.js"></script>

    <script>
        // $(document).ready(...)：確保網頁 HTML 全部載入完成後才執行 JS
        // 避免網頁元素還沒畫好，程式就找不到 #productsTable 在哪裡
        $(document).ready(function(){

            // 初始化 DataTable，並將其實例存入變數 table 以便後續操作
            var table = $("#productsTable").DataTable({

                // ★ UX 優化重點：狀態保存 (State Saving)
                // 設定為 true 後，瀏覽器會記住使用者的操作（例如：翻到第 3 頁、搜尋了 "貓罐頭"）。
                // 當使用者點進「編輯」再按「上一頁」回來時，不會跳回第 1 頁，使用者體驗 (UX) 大加分！
                stateSave: true,

                // ★ 資料來源設定 (Ajax)
                // 透過非同步請求向後端 API 要資料，網頁不用重新整理
                ajax:{
                    type: "POST", // 使用 POST 請求
                    url: "/Shop/Products/IndexJson", // 對應 Controller 的 IndexJson 方法

                    // 成功拿到資料後的處理
                    dataSrc: function(data){
                        return data; // 直接回傳 JSON 陣列給 DataTables 渲染
                    },
                    // 錯誤處理：方便開發者在 F12 Console 看到紅字錯誤
                    error: function (xhr, error, thrown) {
                        console.error("資料載入失敗:", error);
                    }
                },

                // 開啟水平捲軸 (手機版或欄位多時必備)
                scrollX: true,

                // 關閉自動寬度計算，改由 CSS 控制，避免欄位寬度在 RWD 縮放時跑掉
                autoWidth: false,

                // ★ 欄位定義 (Columns)
                // data: 對應後端 JSON 的屬性名稱 (camelCase)
                // render: 決定該欄位要顯示什麼 HTML (這是 DataTables 最強大的功能)
                columns:[
                    // 1. 圖片欄位
                    {
                        data: "thumbnail",
                        width: "8%",
                        orderable: false, // 圖片不需要排序功能
                        render: function(data, type, row) {
                            // data 是 Base64 字串，如果有值就顯示圖片，沒值就顯示預設圖示
                            if (data) {
                                return `<img src="${data}" class="product-thumbnail" alt="商品圖">`;
                            } else {
                                return `<div class="bg-light d-flex align-items-center justify-content-center product-thumbnail text-muted"><i class="fa-solid fa-image"></i></div>`;
                            }
                        }
                    },

                    // 2. 商品名稱
                    { data: "productName", width: "20%" },

                    // 3. 分類名稱 (顯示中文名稱而非 ID)
                    { data: "categoryName", width: "10%" },

                    // 4. 賣家信箱 (顯示 Email 而非 MemberId)
                    { data: "sellerEmail", width: "15%" },

                    // 5. 單價
                    {
                        data: "price",
                        width: "8%",
                        // 使用 DataTables 內建格式化工具，自動加上千分位與 '$' 符號
                        render: $.fn.dataTable.render.number(',', '.', 0, '$')
                    },

                    // 6. 庫存
                    {
                        data: "stock",
                        width: "8%",
                        render: function(data) {
                            // 邏輯判斷：如果庫存少於 10，加入紅色粗體樣式 (警示效果)
                            if(data < 10) return `<span class="text-danger fw-bold">${data}</span>`;
                            return data;
                        }
                    },

                    // 7. 狀態
                    {
                        data: "status",
                        width: "10%",
                        render: function(data) {
                            // 視覺優化：依據文字內容回傳不同的 Bootstrap Badge (徽章)
                            if(data === '上架中') return `<span class="badge bg-success">上架中</span>`;
                            if(data === '缺貨中') return `<span class="badge bg-warning text-dark">缺貨中</span>`;
                            if(data === '已下架') return `<span class="badge bg-secondary">已下架</span>`;
                            return data;
                        }
                    },

                    // 8. 建立時間
                    {
                        data: "createDate",
                        width: "12%",
                        className: "text-nowrap", // 套用 CSS 不換行
                        render: function(data, type, row){
                            if(!data) return "";
                            // 日期格式化：將後端的 ISO 時間字串轉為台灣習慣的格式
                            var date = new Date(data);
                            return date.toLocaleString('zh-TW', {
                                year: 'numeric', month: '2-digit', day: '2-digit',
                                hour: '2-digit', minute: '2-digit'
                            });
                        }
                    },

                    // 9. 管理功能按鈕
                    {
                        data: "productId", // 這裡需要 ID 來生成網址
                        width: "12%",
                        orderable: false, // 按鈕欄位不排序
                        className: "text-nowrap",
                        render: function(data, type, row) {
                            // 使用 Template Literals (反引號 `) 動態生成 HTML
                            // ${data} 會被自動替換成 productId
                            return `
                                <div class="btn-group" role="group">
                                    <a href="/Shop/Products/Edit/${data}" class="btn btn-sm btn-warning text-dark" title="編輯">
                                        <i class="fa-solid fa-pen-to-square"></i> 編輯
                                    </a>
                                    <a href="/Shop/Products/Details/${data}" class="btn btn-sm btn-info text-white" title="明細">
                                        <i class="fa-solid fa-circle-info"></i> 明細
                                    </a>
                                    <a href="/Shop/Products/Delete/${data}" class="btn btn-sm btn-danger" title="刪除">
                                        <i class="fa-solid fa-trash"></i> 刪除
                                    </a>
                                </div>
                            `;
                        }
                    }
                ],

                // 設定語言包：將介面改為繁體中文
                language:{
                    url: '//cdn.datatables.net/plug-ins/2.3.5/i18n/zh-HANT.json',
                },

                // 初始化完成後的動作
                initComplete: function(settings, json) {
                    // 延遲 200ms 重新校正欄位寬度，確保畫面渲染完畢後表格線條是對齊的
                    setTimeout(function() {
                        table.columns.adjust();
                    }, 200);
                }
            });

            // ★ 進階 RWD 優化：ResizeObserver
            // 問題：當左側選單收合或展開時，表格容器寬度變了，但 DataTables 不一定知道要重畫。
            // 解法：使用 ResizeObserver 監聽容器寬度變化，強制 DataTables 重新計算欄寬。
            var tableContainer = document.querySelector('#productsTable').parentElement;

            if (window.ResizeObserver) {
                const resizeObserver = new ResizeObserver(entries => {
                    // requestAnimationFrame 確保瀏覽器準備好繪製下一幀時才執行，效能較好
                    window.requestAnimationFrame(() => {
                        table.columns.adjust();
                    });
                });
                resizeObserver.observe(tableContainer);
            } else {
                // 如果瀏覽器太舊不支援 ResizeObserver，退回使用舊的 window resize 事件
                $(window).on('resize', function () {
                    table.columns.adjust();
                });
            }
        });
    </script>
}