<div class="home-container">
  <header class="hero-section">
    <h2>æ‰€æœ‰æ–‡ç« </h2>
    <h3>åˆ†äº«ä½ çš„å¯µç‰©æ•…äº‹ã€äº¤æµé£¼é¤Šç¶“é©—ï¼</h3>
    <h4>é¦–é  / è«–å£‡ / æ‰€æœ‰æ–‡ç« </h4>
  </header>
  @if (showModal) {
  <div class="modal-overlay" (click)="closeModal()">
    <div style="margin-top: 100px; width: 80%;height: 80%; overflow: auto;" class="modal-content"
      (click)="$event.stopPropagation()">
      <h2 class="modal-title">
        @if (modalMode === 'create') { æ–°å¢æ–‡ç« 
        <button type="button" (click)="fillDemoData()" class="btn-demo"
          style="font-size: 12px; margin-left: 10px; padding: 2px 8px; cursor: pointer;">
          ä¸€éµå¸¶å…¥
        </button> }
        @else if (modalMode === 'edit') { ç·¨è¼¯æ–‡ç«  }
        @else { æ–‡ç« è©³æƒ… }
      </h2>
      <button class="modal-close" (click)="closeModal()">&times;</button>
      <form [formGroup]="articleForm" (ngSubmit)="submitForm()">
        <div [ngClass]="{'readonly-form': modalMode === 'view'}">
          <div class="form-group">
            <label for="category">åˆ†é¡ï¼š</label>
            @if (modalMode === 'edit' || modalMode === 'view') {
            <div class="static-value-box">
              {{ editingArticle?.categoryName }}
            </div>
            <input type="hidden" formControlName="categoryId">
            } @else {
            <select id="category" formControlName="categoryId">
              <option [value]="1">ç‹—ç‹—å°ˆå€</option>
              <option [value]="2">è²“å’ªå°ˆå€</option>
            </select>
            }
          </div>
          <div class="form-group">
            <label for="tag">æ¨™ç±¤ï¼š</label>
            @if (modalMode === 'edit' || modalMode === 'view') {
            <div class="static-value-box">
              {{ editingArticle?.tagName }}
            </div>
            <input type="hidden" formControlName="tagId">
            } @else {
            <select id="tag" formControlName="tagId">
              @for (t of getAvailableTags(); track t.id) {
              <option [value]="t.id">{{ t.name }}</option>
              }
            </select>
            }
          </div>
          <!-- <div class="form-group">
            <label for="member">æœƒå“¡ (å¿…å¡«):</label>
            <input id="member" type="text" formControlName="memberName" [readonly]="modalMode === 'view'">
            @if (articleForm.get('MemberId')?.invalid && articleForm.get('MemberId')?.touched) {
            <div class="error-message">æœƒå“¡æ˜¯å¿…å¡«æ¬„ä½ã€‚</div>
            }
          </div> -->
          <div class="form-group">
            <label for="member">æœƒå“¡åç¨±ï¼š</label>
            @if (modalMode === 'edit' || modalMode === 'view') {
            <div class="static-value-box">
              <span class="member-name-text">{{ editingArticle?.memberName || 'ç³»çµ±æœƒå“¡' }}</span>
            </div>
            <input type="hidden" formControlName="memberId">
            }
            @else {
            <input id="member" type="text" list="memberOptions" (input)="onMemberInput($event)" placeholder="è«‹è¼¸å…¥æœƒå“¡å§“å"
              class="form-control">
            <datalist id="memberOptions">
              @for (m of members; track m.memberId) {
              <option [value]="m.name"></option>
              }
            </datalist>
            <input type="hidden" formControlName="memberId">
            @if (articleForm.get('memberId')?.invalid && articleForm.get('memberId')?.touched) {
            <div class="error-message text-danger">è«‹é¸æ“‡æ­£ç¢ºçš„æœƒå“¡å§“åã€‚</div>
            }
            }
          </div>
          <div class="form-group">
            <label for="title">æ¨™é¡Œï¼š</label>
            <input id="title" type="text" formControlName="title" [readonly]="modalMode === 'view'">
            @if (articleForm.get('title')?.invalid && articleForm.get('title')?.touched) {
            <div class="error-message">æ¨™é¡Œæ˜¯å¿…å¡«æ¬„ä½ã€‚</div>
            }
          </div>
          <div class="form-group">
            <label for="content">æ–‡ç« å…§å®¹ï¼š</label>
            <textarea id="content" formControlName="content" rows="5" [readonly]="modalMode === 'view'"
              style="resize: none;"></textarea>
            @if (articleForm.get('content')?.invalid && articleForm.get('content')?.touched) {
            <div class="error-message">æ–‡ç« å…§å®¹æ˜¯å¿…å¡«æ¬„ä½ã€‚</div>
            }
          </div>
          <!-- <div class="form-group" style="visibility: hidden;"> -->
          <!-- <label for="contentCount">å›è¦†æ¬¡æ•¸</label> -->
          <!-- </div> -->
          <!-- <div class="form-group" style="visibility: hidden;"> -->
          <!-- <label for="postDate">ç™¼ä½ˆæ—¥æœŸ</label> -->
          <!-- </div> -->
          <!-- <div class="form-group" style="visibility: hidden;"> -->
          <!-- <label for="lastUpdate">æœ€å¾Œæ›´æ–°</label> -->
          <!-- </div> -->
          <!-- <div class="form-group" style="visibility: hidden;"> -->
          <!-- <label for="contentCount">å›è¦†æ¬¡æ•¸</label> -->
          <!-- </div> -->
          <div class="form-group">
            <label for="picture">åœ–ç‰‡</label>
            @if (modalMode !== 'view') {
            <input type="file" id="picture" accept="image/*" (change)="onFileSelected($event)"
              class="form-control-file">
            }
            @if (imagePreview || articleForm.get('picture')?.value) {
            <div class="image-display-box">
              <img [src]="imagePreview || articleForm.get('picture')?.value" alt="æ–‡ç« åœ–ç‰‡" class="preview-img">
            </div>
            } @else if (modalMode === 'view') {
            <div class="no-image-text">æ­¤æ–‡ç« ç„¡é™„ä»¶åœ–ç‰‡</div>
            }
          </div>
        </div>
        @if (modalMode !== 'view') {

        <div class="form-actions">
          <button type="submit" [disabled]="articleForm.invalid" class=" btn-submit">
            {{ modalMode === 'create' ? 'æ–°å¢æ–‡ç« ' : 'å„²å­˜è®Šæ›´' }}
          </button>
          <button type="button" class=" btn-secondary" (click)="closeModal()">
            å–æ¶ˆ
          </button>
        </div>
        } @else {
        <!-- è®š/å€’è®šåˆ‡æ›ï¼Œé è¨­ç°è‰²ï¼Œè®šï¼šç¶ /å€’è®šï¼šç´… -->
        <div class="form-actions">
          <div class="vote-section">
            <button type="button" class="btn-like" [class.voted-green]="editingArticle?.userVote === 'like'"
              (click)="likeArticle(editingArticle!.articleId)">
              ğŸ‘ {{ editingArticle?.userVote === 'like' ? 'å·²è®š' : 'è®š' }}
              ({{ editingArticle?.like ?? 0 }})
            </button>

            <button type="button" class="btn-dislike" [class.voted-red]="editingArticle?.userVote === 'dislike'"
              (click)="dislikeArticle(editingArticle!.articleId)">
              ğŸ‘ {{ editingArticle?.userVote === 'dislike' ? 'å·²å€’è®š' : 'å€’è®š' }}
              ({{ editingArticle?.disLike ?? 0 }})
            </button>
          </div>
          <button type="button" class="btn-secondary" (click)="closeModal()">
            é—œé–‰
          </button>
        </div>
        <div class="comments-section" style="margin-top: 20px; border-top: 2px solid #eee; padding-top: 15px;">
          <h4 style="color: #2c3e50; margin-bottom: 15px;">
            <i class="fas fa-reply"></i> å…¨éƒ¨å›è¦† ({{ articleComments.length }})
          </h4>
          <div class="comment-scroll-box" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
            @for (comment of articleComments; track comment.commentId) {
            <div class="comment-item"
              style="background: #f8f9fa; border-radius: 10px; padding: 12px; margin-bottom: 10px; border-left: 4px solid #8E8375;">
              <div class="d-flex justify-content-between align-items-center">
                <strong style="color: #34495e;">{{ comment.memberName }}</strong>
                <small class="text-muted">{{ formatDate(comment.postDate) }}</small>
              </div>
              <p style="margin: 8px 0 0; color: #444; white-space: pre-wrap;">{{ comment.content }}</p>
            </div>
            } @empty {
            <div style="text-align: center; padding: 30px; color: #999;">
              <p>ç›®å‰é‚„æ²’æœ‰äººå›è¦†ï¼Œå¿«ä¾†ç•™è¨€å§ï¼</p>
            </div>
            }
          </div>
          <div class="reply-input-area" [formGroup]="commentForm">
            <textarea formControlName="content" class="form-control" placeholder="æ’°å¯«ä½ çš„å›è¦†..." rows="3"
              style="resize: none; border-radius: 8px; margin-bottom: 10px;"></textarea>
            <div style="text-align: right;">
              <button class="btn-reply " [disabled]="commentForm.invalid" (click)="submitComment()">
                ç™¼ä½ˆå›è¦†
              </button>
            </div>
          </div>
        </div>
        }
      </form>
    </div>
  </div>
  }
  <section class="latest-posts-section">
    <h2>æœ€æ–°æ–‡ç« 
      <!-- æ¨™ç±¤ç¯©é¸  ä¸‹æ‹‰å¼é¸å–® -->
      <div class="filter-controls">
        <select class="select" id="tagFilter" [(ngModel)]="selectedTag" (change)="onTagFilterChange($event)">
          <option value="å…¨éƒ¨æ¨™ç±¤">å…¨éƒ¨æ¨™ç±¤</option>
          @for(tag of getAvailableTags(); track tag.id) {
          <option [value]="tag.id">{{ tag.name }}</option>
          }
        </select>
        <div class="search-group" style="display: flex; gap: 5px;">
          <input type="text" [(ngModel)]="searchKeyword" placeholder="æœå°‹æ–‡ç« ..." (keyup.enter)="onSearch()"
            class="form-control" style="width: 180px; height: 38px;">
          <button type="button" class="btn-search" (click)="onSearch()"
            style="border:1px solid #5E5344; white-space: nowrap;">
            æœå°‹
          </button>
          @if (searchKeyword) {
          <button type="button" class="btn-clear btn-outline-secondary" (click)="clearSearch()"
            style="border:1px solid #5E5344; white-space: nowrap;">
            æ¸…é™¤
          </button>
          }
        </div>
        <button style="border:1px solid #5E5344; white-space: nowrap;" class="primary-button"
          (click)="createNewArticle()">ç™¼ä½ˆæ–°è²¼æ–‡</button>
        <button style="border:1px solid #5E5344; white-space: nowrap;" class="btn-favorites"
          routerLink="/forum/favorites">
          <i class="fa-regular fa-bookmark"></i> æˆ‘çš„æ”¶è—
        </button>
      </div>
    </h2>
    <table class="post-table">
      <thead>
        <!-- æ¨™é¡Œæ¬„ä½ -->
        <tr>
          <th style="width: 0px;"></th>
          <th style="width: 55px;">æ”¶è—</th>
          <th style="width: 75px;" (click)="sortArticles('categoryId')" [class.sortable]="true">é¡åˆ¥
            <span class="sort-icon" [ngClass]="getSortIcon('categoryId')">
            </span>
          </th>
          <th style="width: 90px;" (click)="sortArticles('tagId')" [class.sortable]="true">æ¨™ç±¤
            <span class="sort-icon" [ngClass]="getSortIcon('tagId')">
            </span>
          </th>
          <th style="width: 65px;">ä½œè€…</th>
          <th style="width: 100px;">æ–‡ç« æ¨™é¡Œ</th>
          <th style="width: 100px;">æ–‡ç« å…§å®¹</th>
          <th style="width: 90px;">å›è¦†æ¬¡æ•¸</th>
          <th style="width: 100px;">ç™¼ä½ˆæ—¥æœŸ</th>
          <th style="width: 100px;" (click)="sortArticles('lastUpdate')" [class.sortable]="true">æœ€å¾Œæ›´æ–°<span
              class="sort-icon" [ngClass]="getSortIcon('lastUpdate')">
            </span>
          </th>
          <th style="width: 95px;" (click)="sortArticles('popular')" [class.sortable]="true">ç†±é–€åº¦
            <span class="sort-icon" [ngClass]="getSortIcon('popular')">
            </span>
          </th>
          <th style="width: 60px;">åœ–ç‰‡</th>
          <th style="width: 90px;">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody style="width: max-content;">
        @for(post of recentPosts;track $index ){
        <tr>
          <td></td>
          <td style="text-align: center;"> <!-- æ”¶è—æŒ‰éˆ• -->
            <button class="btn btn-link p-0" (click)="toggleFavorite(post); $event.stopPropagation()"
              style="text-decoration: none; border: none; background: transparent;">
              <i [class]="post.isFavorited ? 'fa-solid fa-bookmark' : 'fa-regular fa-bookmark'"
                [style.color]="post.isFavorited ? '#e67e22' : '#95a5a6'" style="font-size: 1.2rem; cursor: pointer;">
              </i>
            </button>
          </td>
          <td>{{ post.categoryName }}</td>
          <td>{{ post.tagName }}</td>
          <td>{{ post.memberName }}</td>
          <td style="max-width: 50px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ post.title }}
          </td>
          <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ post.content
            }}</td>
          <td>{{ post.commentCount }}</td>
          <td>{{ formatDate(post.postDate) }}</td>
          <td>{{ formatDate(post.lastUpdate) }}</td>
          <td>{{ post.popular }}</td>
          <td>
            @if (post.picture) {
            <img [src]="post.picture" alt="åœ–ç‰‡" style="max-width: 100px;">
            }
          </td>
          <!-- è©³ç´°/ä¿®æ”¹/åˆªé™¤ æŒ‰éµ -->
          <td class="action-buttons">
            <button class="btn btn-detail" (click)="viewDetails(post)">
              è©³ç´°
            </button>
            <button class="btn btn-edit" (click)="editArticle(post)">
              ä¿®æ”¹
            </button>
            <button class="btn btn-delete" (click)="deleteArticle(post.articleId)">
              åˆªé™¤
            </button>
          </td>
        </tr>
        }
      </tbody>
    </table>
    <!-- å´é‚Šæ¬„ä½ -->
    <div class="sidebar">
      <h3>åˆ†é¡ç€è¦½</h3>
      <ul>
        <li><a href="javascript:void(0)" (click)="selectCategory(null); $event.preventDefault()"
            [class.active]="selectedCategory === null">å…¨éƒ¨</a></li>
        <li><a href="javascript:void(0)" (click)="selectCategory(1); $event.preventDefault()"
            [class.active]="selectedCategory === 1">ç‹—ç‹—å°ˆå€</a></li>
        <li><a href="javascript:void(0)" (click)="selectCategory(2); $event.preventDefault()"
            [class.active]="selectedCategory === 2">è²“å’ªå°ˆå€</a></li>
      </ul>
    </div>
    <!-- æ¯é é¡¯ç¤ºå¹¾ç­† -->
    <div class="pagination-controls">
      <div class="page-size-selector">
        <label for="pageSize">æ¯é é¡¯ç¤ºç­†æ•¸ï¼š</label>
        <select id="pageSize" [(ngModel)]="pageSize" (change)="onPageSizeChange()">
          <option [ngValue]="5">5 ç­†</option>
          <option [ngValue]="10">10 ç­†</option>
          <option [ngValue]="25">25 ç­†</option>
        </select>
      </div>
      <!-- æ›é æŒ‰éµ -->
      <div class="pagination-buttons">
        <button class="btn-pagination" [disabled]="currentPage === 1" (click)="goToPage(1) ">
          &laquo;
        </button>
        <button class="btn-pagination" [disabled]="currentPage === 1" (click)="goToPage(currentPage - 1)">
          &lsaquo;
        </button>
        <span>
          ç¬¬ {{ currentPage }} é  / å…± {{ totalPages }} é 
        </span>
        <button class=" btn-pagination" [disabled]="currentPage === totalPages" (click)="goToPage(currentPage + 1)">
          &rsaquo;
        </button>
        <button class=" btn-pagination" [disabled]="currentPage === totalPages" (click)="goToPage(totalPages)">
          &raquo;
        </button>
      </div>
    </div>
  </section>
</div>