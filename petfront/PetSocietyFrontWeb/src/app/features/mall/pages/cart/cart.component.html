<div class="mall-container fadein animation-duration-500 py-5" style="max-width: 1600px; margin: 0 auto;">

  <div class="flex align-items-center gap-3 mb-5 pb-3 mx-3"
    style="border-bottom: 2px solid var(--color-primary-light);">
    <i class="pi pi-shopping-cart text-4xl" style="color: var(--color-btn);"></i>
    <h1 class="text-3xl font-bold m-0" style="color: var(--color-text-dark);">我的購物車</h1>
  </div>

  <div *ngIf="isLoading"
    class="flex flex-column justify-content-center align-items-center w-full fadein animation-duration-500"
    style="min-height: 400px;">
    <i class="pi pi-heart-fill loading-heart-icon mb-3"></i>
    <div class="text-primary-600 font-bold text-xl">正在細心整理您的購物車... 🛒💝</div>
  </div>

  <div class="grid m-0 fadein animation-duration-500" *ngIf="!isLoading">

    <div class="col-12 lg:col-8 p-3">

      <div class="surface-card p-4 border-round-2xl shadow-1 mb-4">
        <p-table [value]="cartItems" [tableStyle]="{'min-width': '40rem'}" styleClass="p-datatable-gridlines-none">
          <ng-template pTemplate="header">
            <tr>
              <th style="width: 15%">商品</th>
              <th style="width: 30%">名稱</th>
              <th style="width: 15%">單價</th>
              <th style="width: 20%">數量</th>
              <th style="width: 15%">小計</th>
              <th style="width: 5%"></th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item>
            <tr class="cart-item-row border-bottom-1 surface-border">
              <td class="py-4">
                <img [src]="item.thumbnail" [alt]="item.productName"
                  (error)="item.thumbnail = 'https://placehold.co/400x400/F2EBE5/5E5344?text=No+Image'"
                  class="w-6rem h-6rem border-round-xl shadow-2" style="object-fit: cover;" />
              </td>
              <td>
                <div class="font-bold text-xl mb-2 text-900">{{ item.productName }}</div>
                <div *ngIf="item.categoryName" class="text-500 text-sm inline-block px-2 py-1 border-round surface-200">
                  {{ item.categoryName }}
                </div>
              </td>
              <td class="font-medium text-lg">NT$ {{ item.price | number }}</td>
              <td>
                <p-inputNumber [(ngModel)]="item.quantity" (ngModelChange)="updateQuantity(item)" [showButtons]="true"
                  buttonLayout="horizontal" spinnerMode="horizontal" [min]="1"
                  inputStyleClass="w-3rem text-center font-bold border-none shadow-none outline-none"
                  class="custom-input-number">
                  <ng-template pTemplate="incrementbuttonicon"><span class="pi pi-plus text-xs"></span></ng-template>
                  <ng-template pTemplate="decrementbuttonicon"><span class="pi pi-minus text-xs"></span></ng-template>
                </p-inputNumber>
              </td>
              <td class="font-bold text-xl text-primary">
                NT$ {{ item.price * item.quantity | number }}
              </td>
              <td>
                <button pButton icon="pi pi-trash"
                  class="p-button-rounded p-button-text text-400 hover:text-red-500 hover:bg-red-50"
                  (click)="deleteItem(item)"></button>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="6" class="text-center p-6">
                <div class="flex flex-column align-items-center">
                  <i class="pi pi-shopping-bag text-600 text-5xl mb-3"></i>
                  <span class="text-xl text-600">購物車空空的，快去幫毛孩買禮物！🐶</span>
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>

      <div class="surface-card p-5 border-round-2xl shadow-1 mt-4" *ngIf="cartItems.length > 0">

        <div class="flex align-items-center justify-content-between mb-5">
          <div class="flex align-items-center">
            <div
              class="bg-primary-50 text-primary border-round-2xl p-3 mr-3 flex align-items-center justify-content-center"
              style="width: 50px; height: 50px">
              <i class="pi pi-truck text-2xl"></i>
            </div>
            <div>
              <div class="text-2xl font-bold text-900">收件資訊</div>
              <div class="text-500 mt-1">請填寫正確資訊以利配送</div>
            </div>
          </div>

          <button pButton type="button" label="Demo" icon="pi pi-bolt"
            class="p-button-outlined p-button-help p-button-sm" pTooltip="快速填入測試資料" tooltipPosition="left"
            (click)="fillDemoData()">
          </button>

        </div>

        <div class="grid formgrid p-fluid">
          <div class="field col-12 md:col-6 mb-4">
            <label class="font-bold text-700 mb-2 ml-1">收件人姓名 <span class="text-red-500">*</span></label>
            <div
              class="flex align-items-center surface-card border-1 surface-border border-round-xl px-3 py-1 transition-colors hover:border-primary focus-within:border-primary focus-within:shadow-1"
              style="height: 3.5rem;">
              <i class="pi pi-user text-500 text-xl mr-3"></i>
              <input pInputText [(ngModel)]="receiver.name" placeholder="請輸入真實姓名"
                class="w-full border-none shadow-none p-0 text-lg text-900 surface-overlay">
            </div>
          </div>

          <div class="field col-12 md:col-6 mb-4">
            <label class="font-bold text-700 mb-2 ml-1">聯絡電話 <span class="text-red-500">*</span></label>
            <div
              class="flex align-items-center surface-card border-1 surface-border border-round-xl px-3 py-1 transition-colors hover:border-primary focus-within:border-primary focus-within:shadow-1"
              style="height: 3.5rem;">
              <i class="pi pi-phone text-500 text-xl mr-3"></i>
              <input pInputText [(ngModel)]="receiver.phone" placeholder="09xx-xxx-xxx"
                class="w-full border-none shadow-none p-0 text-lg text-900 surface-overlay">
            </div>
          </div>

          <div class="field col-12 mb-4">
            <label class="font-bold text-700 mb-2 ml-1">電子信箱 (選填)</label>
            <div
              class="flex align-items-center surface-card border-1 surface-border border-round-xl px-3 py-1 transition-colors hover:border-primary focus-within:border-primary focus-within:shadow-1"
              style="height: 3.5rem;">
              <i class="pi pi-envelope text-500 text-xl mr-3"></i>
              <input pInputText [(ngModel)]="receiver.email" placeholder="接收訂單通知信"
                class="w-full border-none shadow-none p-0 text-lg text-900 surface-overlay">
            </div>
          </div>

          <div class="field col-12">
            <label class="font-bold text-700 mb-2 ml-1">寄送地址 <span class="text-red-500">*</span></label>
            <div
              class="flex align-items-center surface-card border-1 surface-border border-round-xl px-3 py-1 transition-colors hover:border-primary focus-within:border-primary focus-within:shadow-1"
              style="height: 3.5rem;">
              <i class="pi pi-map-marker text-500 text-xl mr-3"></i>
              <input pInputText [(ngModel)]="receiver.address" placeholder="詳細縣市、區域、街道"
                class="w-full border-none shadow-none p-0 text-lg text-900 surface-overlay">
            </div>
          </div>
        </div>
      </div>

    </div>

    <div class="col-12 lg:col-4 p-3">
      <div class="surface-card p-5 shadow-4 border-round-2xl sticky top-0" style="top: 2rem;">
        <h2 class="text-2xl font-bold mb-5 pb-3 border-bottom-1 surface-border text-900">
          訂單摘要</h2>

        <div class="flex justify-content-between mb-3 text-lg">
          <span class="text-600">商品總計 ({{ cartItems.length }} 項)</span>
          <span class="font-bold text-900">NT$ {{ totalPrice | number }}</span>
        </div>

        <div class="flex justify-content-between mb-4 text-lg">
          <span class="text-600">運費</span>
          <span class="text-green-500 font-bold">免運費活動中</span>
        </div>

        <p-divider styleClass="my-4"></p-divider>

        <div class="flex justify-content-between mb-5 align-items-end">
          <span class="text-xl font-bold text-900">總金額</span>
          <span class="text-4xl font-bold text-primary">
            <span class="text-2xl">NT$</span> {{ totalPrice | number }}
          </span>
        </div>

        <button pButton label="前往結帳" icon="pi pi-credit-card" iconPos="right"
          class="w-full text-xl font-bold py-3 border-round-xl shadow-3 mb-4" (click)="checkout()">
        </button>

        <div class="text-center">
          <a routerLink="/mall"
            class="text-500 no-underline hover:text-primary cursor-pointer transition-colors transition-duration-200 flex align-items-center justify-content-center gap-2">
            <i class="pi pi-arrow-left"></i>
            <span class="font-medium">繼續選購商品</span>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<form #paymentForm method="post" [action]="paymentUrl" style="display: none;">
  <input type="text" name="MerchantID" [value]="paymentData.MerchantID">
  <input type="text" name="TradeInfo" [value]="paymentData.TradeInfo">
  <input type="text" name="TradeSha" [value]="paymentData.TradeSha">
  <input type="text" name="Version" [value]="paymentData.Version">
</form>